<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat • One Tab</title>
    <style>
        :root { font-family: ui-sans-serif, system-ui, Arial; }
        body { margin: 0; background:#0b0c10; color:#e5e7eb; }
        header { padding: 14px 16px; border-bottom:1px solid #1f2937; display:flex; align-items:center; gap:12px; }
        .tab { font-weight:600; }
        .container { max-width: 800px; margin: 0 auto; padding: 16px; }
        .messages { border:1px solid #1f2937; border-radius:12px; padding: 12px; height: 60vh; overflow:auto; background:#111827; }
        .msg { margin: 10px 0; padding: 10px 12px; border-radius:10px; line-height:1.45; white-space:pre-wrap; }
        .user { background:#1f2937; }
        .assistant { background:#0f172a; }
        .system { opacity:.8; font-style:italic; }
        form { display:flex; gap:8px; margin-top: 12px; }
        input, button { font-size: 16px; }
        input[type=text] { flex:1; padding:12px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; }
        button { padding: 10px 14px; border-radius:10px; background:#2563eb; color:white; border:none; cursor:pointer; }
        button.secondary { background:#374151; }
        .muted { opacity:.7; font-size: 12px; margin-left: 12px; }
    </style>
</head>
<body>
    <header>
        <div class="tab">Chat</div>
        <div class="muted" id="who"></div>
        <div style="margin-left:auto; display:flex; gap:8px;">
            <button id="signin">Dev Sign‑in</button>
            <button id="start">Start</button>
            <button id="end" class="secondary">End</button>
        </div>
    </header>
    <div class="container">
        <div id="messages" class="messages"></div>
        <form id="form">
            <label for="input"></label><input id="input" type="text" placeholder="Type a message…" autocomplete="off" />
            <button type="submit">Send</button>
        </form>
    </div>
<!-- 1) Load helper first (optional). If you still want DevAuth, keep this line; otherwise remove all DevAuth lines below. -->
<script src="dev-activation.js"></script>

<script>
  let sessionId = null;
  let token = localStorage.getItem('token') || '';
  // 1) Use your Render base URL
  const API_BASE = 'https://apk-agent.onrender.com';
  const api = (path) => `${API_BASE}${path}`;

  const $msgs = document.getElementById('messages');
  const $form = document.getElementById('form');
  const $input = document.getElementById('input');
  const $start = document.getElementById('start');
  const $end = document.getElementById('end');
  const $signin = document.getElementById('signin');
  const $who = document.getElementById('who');

  function hdr(){ return token ? { 'Authorization': `Bearer ${token}` } : {}; }
  function add(role, text){
    const el = document.createElement('div');
    el.className = `msg ${role}`;
    el.textContent = text;
    $msgs.appendChild(el);
    $msgs.scrollTop = $msgs.scrollHeight;
    return el;
  }
  function setWho(){
    const ul = localStorage.getItem('ul') === '1';
    $who.textContent = token ? `authed${ul ? ' (UL)' : ''}` : 'anonymous';
  }
  setWho();

  // 2) Dev Sign-in via POST JSON (user_id + password)
  async function devSignin() {
  const userId = window.prompt('Enter user id (e.g. demo@local):', 'demo@local');
  if (userId == null) return;

  console.log('[signin] requested');
  const res = await fetch(
    `https://apk-agent.onrender.com/api/auth/dev-token?user_id=${encodeURIComponent(userId)}`,
    { method: 'GET', mode: 'cors' }
  );

  if (!res.ok) {
    add('system', `Sign-in failed (${res.status}).`);
    return;
  }

  const data = await res.json();
  token = data.token;
  localStorage.setItem('token', token);
  localStorage.setItem('ul', data.ul ? '1' : '0');
  console.log('[signin] request granted');
  add('system', `Signed in as ${userId}${data.ul ? ' (unlimited)' : ''}.`);
  setWho();
}


  async function startConversation(){
    console.log('[start] POST /api/conversations');
    const res = await fetch(api('/api/conversations'), { method:'POST', headers: hdr(), mode:'cors' });
    console.log('[start] status', res.status);
    if (res.status === 401){ add('system', 'Unauthorized. Click Dev Sign-in.'); return; }
    if (!res.ok){ add('system', `Start failed (${res.status}).`); return; }
    const data = await res.json();
    sessionId = data.session_id;
    add('system', `Session started: ${sessionId}`);
  }

  async function endConversation(){
    if(!sessionId) return;
    console.log('[end] POST /api/conversations/:id/end');
    const res = await fetch(api(`/api/conversations/${sessionId}/end`), { method:'POST', headers: hdr(), mode:'cors' });
    if(res.status === 429){ add('system', 'Rate limit hit. Try later.'); return; }
    if(!res.ok){ add('system', `End failed (${res.status}).`); return; }
    const data = await res.json();
    add('system', `Ended. Log saved at: ${data.log_path}`);
    sessionId = null;
  }

  $signin.addEventListener('click', devSignin);
  $start.addEventListener('click', startConversation);
  $end.addEventListener('click', endConversation);

  $form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = $input.value.trim();
    if(!text) return;

    if(!token){ add('system','Unauthorized. Click Dev Sign-in first.'); return; }

    // Ensure we have a session
    if(!sessionId){
      await startConversation();
      if(!sessionId) return; // start failed (e.g., 401)
    }

    add('user', text);
    $input.value = '';

    const el = add('assistant', '');
    console.log('[chat] POST /api/conversations/:id/messages', { sessionId });

    const resp = await fetch(api(`/api/conversations/${sessionId}/messages`), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...hdr() },
      body: JSON.stringify({ message: text }),
      mode:'cors'
    });

    console.log('[chat] status', resp.status);
    if(resp.status === 429){ el.textContent = 'Rate limit hit. Try later.'; return; }
    if(!resp.ok){ el.textContent = `Error ${resp.status}`; return; }

    // Support both streaming and non-streaming responses:
    const reader = resp.body?.getReader?.();
    if (reader) {
      const decoder = new TextDecoder();
      while(true){
        const { done, value } = await reader.read();
        if(done) break;
        el.textContent += decoder.decode(value, { stream: true });
        $msgs.scrollTop = $msgs.scrollHeight;
      }
    } else {
      const data = await resp.json();
      el.textContent = data.reply ?? data.message ?? JSON.stringify(data);
    }
  });

  // Optional: DevAuth helper if you keep it
  if (window.DevAuth && typeof DevAuth.wrapGlobalFetch === 'function') {
    DevAuth.wrapGlobalFetch();
  }
</script>


</body>
</html>